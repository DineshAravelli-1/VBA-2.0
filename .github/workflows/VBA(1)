Sub WriteListToSharePoint()
    Dim objXML As MSXML2.XMLHTTP60
    Dim SharePointURL As String
    Dim ws As Worksheet
    Dim jsonData As String
    Dim responseText As String
    Dim digestValue As String
    Dim i As Integer
    Dim colCount As Integer

    ' Initialize variables
    SharePointURL = "http://sharepoint3.bankofamerica.com/sites/GBS_GCAOO_AML_Onboarding/_api/web/lists/getbytitle('Work_Tracker')/items"
    Set ws = ThisWorkbook.Sheets("UploadData")

    ' Get form digest value
    digestValue = GetFormDigest("http://sharepoint3.bankofamerica.com/sites/GBS_GCAOO_AML_Onboarding")

    ' Create XMLHTTP object
    Set objXML = New MSXML2.XMLHTTP60

    ' Determine the number of columns
    colCount = ws.Cells(1, ws.Columns.Count).End(xlToLeft).Column

    ' Loop through each column and build JSON data
    jsonData = "{" & """__metadata"": {""type"": ""SP.Data.Work_TrackerListItem""},"
    For i = 1 To colCount
        Debug.Print "Column Header: " & ws.Cells(1, i).Value ' Print the field name for debugging
        jsonData = jsonData & """" & ws.Cells(1, i).Value & """: """ & ws.Cells(2, i).Value & """"
        If i <> colCount Then
            jsonData = jsonData & ", "
        End If
    Next i
    jsonData = jsonData & "}"

    ' Print the JSON data for debugging
    Debug.Print "JSON Data: " & jsonData

    ' Print the URL being used
    Debug.Print "URL: " & SharePointURL

    ' Prepare the HTTP request
    objXML.Open "POST", SharePointURL, False
    objXML.setRequestHeader "Content-Type", "application/json;odata=verbose"
    objXML.setRequestHeader "Accept", "application/json;odata=verbose"
    objXML.setRequestHeader "X-RequestDigest", digestValue
    objXML.Send jsonData

    ' Check the response
    responseText = objXML.responseText
    If objXML.Status = 201 Then
        Debug.Print "Item uploaded successfully!"
        MsgBox "Item uploaded successfully!"
    Else
        Debug.Print "Upload failed. Status: " & objXML.Status & "; Response: " & responseText
        MsgBox "Upload failed. Status: " & objXML.Status & "; Response: " & responseText
    End If

    ' Clean up
    Set objXML = Nothing
End Sub

Function GetFormDigest(siteURL As String) As String
    Dim objXML As MSXML2.XMLHTTP60
    Dim jsonResponse As Object
    Dim strDigest As String

    ' Create XMLHTTP object
    Set objXML = New MSXML2.XMLHTTP60

    ' Prepare the HTTP request to get the form digest value
    objXML.Open "POST", siteURL & "/_api/contextinfo", False
    objXML.setRequestHeader "Accept", "application/json;odata=verbose"
    objXML.setRequestHeader "Content-Type", "application/json;odata=verbose"
    objXML.send

    ' Check if the response is in JSON format and parse it
    If objXML.Status = 200 Then
        Set jsonResponse = JsonConverter.ParseJson(objXML.responseText)
        strDigest = jsonResponse("d")("GetContextWebInformation")("FormDigestValue")
    Else
        MsgBox "Failed to get form digest. Response is not in JSON format. Status: " & objXML.Status
        strDigest = ""
    End If

    ' Clean up
    Set objXML = Nothing
    GetFormDigest = strDigest
End Function
